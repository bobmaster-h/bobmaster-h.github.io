<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ™ºèƒ½å›¾ç‰‡ / è§†é¢‘å‹ç¼© + é“¾æ¥è§£æ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body {
  font-family: system-ui;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
h2,h3 { margin-top: 30px }
.card {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
}
input,button,select {
  width: 100%;
  margin: 8px 0;
}
button {
  background: #2563eb;
  border: none;
  padding: 12px;
  border-radius: 8px;
  color: white;
  font-size: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
td,th {
  border-bottom: 1px solid #1e293b;
  padding: 6px;
}
small { color: #94a3b8 }
progress { width: 100% }
</style>
</head>

<body>

<h2>ğŸ“¦ æ™ºèƒ½å‹ç¼©å·¥å…·ï¼ˆæœ¬åœ°ï¼‰</h2>

<!-- å›¾ç‰‡ -->
<div class="card">
<h3>ğŸ“· æ‰¹é‡å›¾ç‰‡æ™ºèƒ½å‹ç¼©</h3>
<input type="file" accept="image/*" multiple id="imgInput">
<button onclick="smartImageCompress()">è‡ªåŠ¨æ™ºèƒ½å‹ç¼©</button>
<table id="imgTable"></table>
</div>

<!-- æœ¬åœ°è§†é¢‘ -->
<div class="card">
<h3>ğŸ¬ æœ¬åœ°è§†é¢‘æ‰¹é‡å‹ç¼©</h3>
<input type="file" accept="video/*" multiple id="videoInput">
<select id="videoMode">
  <option value="auto">æ¨èï¼ˆè‡ªåŠ¨ï¼‰</option>
  <option value="quality">ç”»è´¨ä¼˜å…ˆ</option>
  <option value="size">ä½“ç§¯æœ€å°</option>
</select>
<button onclick="compressLocalVideos()">å¼€å§‹å‹ç¼©</button>
<progress id="vProgress" value="0" max="1"></progress>
<table id="videoTable"></table>
</div>

<!-- é“¾æ¥è§£æ -->
<div class="card">
<h3>ğŸ”— æŠ–éŸ³ / Bç«™é“¾æ¥ä¸‹è½½ + å‹ç¼©</h3>
<input placeholder="ç²˜è´´è§†é¢‘åˆ†äº«é“¾æ¥" id="shareUrl">
<small>âš ï¸ éœ€è¦ä½ è‡ªå·±çš„è§£ææ¥å£</small>
<button onclick="parseAndCompress()">è§£æå¹¶å‹ç¼©</button>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>
/* ========== å›¾ç‰‡æ™ºèƒ½å‹ç¼© ========== */
async function smartImageCompress() {
  const table = imgTable;
  table.innerHTML = "<tr><th>æ–‡ä»¶</th><th>åŸå§‹</th><th>å‹ç¼©å</th><th>ä¸‹è½½</th></tr>";

  for (const file of imgInput.files) {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    let bestBlob = null;
    for (let q of [0.82, 0.75, 0.68]) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img,0,0);
      const blob = await new Promise(r=>canvas.toBlob(r,"image/webp",q));
      if (!bestBlob || blob.size < bestBlob.size) bestBlob = blob;
    }

    table.innerHTML += `
    <tr>
      <td>${file.name}</td>
      <td>${(file.size/1024).toFixed(1)} KB</td>
      <td>${(bestBlob.size/1024).toFixed(1)} KB</td>
      <td><a download="${file.name}.webp" href="${URL.createObjectURL(bestBlob)}">ä¸‹è½½</a></td>
    </tr>`;
  }
}

/* ========== æœ¬åœ°è§†é¢‘å‹ç¼© ========== */
async function compressLocalVideos() {
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({
    log:true,
    progress:p=>vProgress.value=p.ratio
  });
  await ffmpeg.load();

  videoTable.innerHTML = "<tr><th>æ–‡ä»¶</th><th>åŸå§‹</th><th>å‹ç¼©å</th><th>ä¸‹è½½</th></tr>";

  for (const file of videoInput.files) {
    ffmpeg.FS("writeFile","in.mp4",await fetchFile(file));
    let crf = videoMode.value==="size"?30:videoMode.value==="quality"?24:28;

    await ffmpeg.run("-i","in.mp4","-vcodec","libx264","-crf",crf,"out.mp4");
    const data = ffmpeg.FS("readFile","out.mp4");
    const blob = new Blob([data.buffer],{type:"video/mp4"});

    videoTable.innerHTML += `
    <tr>
      <td>${file.name}</td>
      <td>${(file.size/1024/1024).toFixed(2)} MB</td>
      <td>${(blob.size/1024/1024).toFixed(2)} MB</td>
      <td><a href="${URL.createObjectURL(blob)}" download="compressed.mp4">ä¸‹è½½</a></td>
    </tr>`;
  }
}

/* ========== é“¾æ¥è§£æï¼ˆæ¥å£å ä½ï¼‰ ========== */
async function parseAndCompress() {
  alert(
`è¿™é‡Œéœ€è¦ä½ è‡ªå·±çš„è§£ææ¥å£ï¼Œä¾‹å¦‚ï¼š
POST https://api.xxx.com/parse
body: { url: åˆ†äº«é“¾æ¥ }

è¿”å›ï¼šçœŸå® mp4 åœ°å€

å‰ç«¯æ‹¿åˆ° mp4 å â†’ ç›´æ¥èµ°ä¸Šé¢çš„å‹ç¼©é€»è¾‘`
  );
}
</script>

</body>
</html>
