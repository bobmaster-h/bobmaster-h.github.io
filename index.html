<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å›¾ç‰‡ / è§†é¢‘æ™ºèƒ½å‹ç¼©ï¼ˆç½‘é¡µç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, -apple-system;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
h2,h3 { margin-top: 24px }
.card {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
}
input, button, select {
  width: 100%;
  margin: 8px 0;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 8px;
  font-size: 15px;
}
button:disabled {
  background: #475569;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  border-bottom: 1px solid #1e293b;
  padding: 6px;
}
small { color: #94a3b8 }
progress { width: 100%; }
a { color: #38bdf8 }
</style>
</head>

<body>

<h2>ğŸ“¦ å›¾ç‰‡ / è§†é¢‘æ™ºèƒ½å‹ç¼©ï¼ˆæœ¬åœ°å¤„ç†ï¼‰</h2>

<!-- å›¾ç‰‡å‹ç¼© -->
<div class="card">
<h3>ğŸ“· å›¾ç‰‡ï¼ˆæ‰¹é‡ + æ™ºèƒ½ï¼‰</h3>
<input type="file" id="imgInput" accept="image/*" multiple>
<button onclick="smartCompressImages()">å¼€å§‹æ™ºèƒ½å‹ç¼©</button>
<table id="imgTable"></table>
</div>

<!-- è§†é¢‘å‹ç¼© -->
<div class="card">
<h3>ğŸ¬ è§†é¢‘ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰</h3>
<input type="file" id="videoInput" accept="video/*" multiple>

<select id="videoMode">
  <option value="auto">æ¨èï¼ˆæ¸…æ™° + å°ï¼‰</option>
  <option value="quality">ç”»è´¨ä¼˜å…ˆ</option>
  <option value="size">ä½“ç§¯æœ€å°</option>
</select>

<button onclick="compressVideos()">å¼€å§‹å‹ç¼©</button>
<progress id="videoProgress" value="0" max="1"></progress>

<table id="videoTable"></table>
</div>

<!-- é“¾æ¥è¯´æ˜ -->
<div class="card">
<h3>ğŸ”— æŠ–éŸ³ / Bç«™é“¾æ¥</h3>
<p>
æµè§ˆå™¨ <b>ä¸èƒ½ç›´æ¥è§£æ</b> æŠ–éŸ³ / Bç«™è§†é¢‘ã€‚<br>
å¦‚æœä½ éœ€è¦ã€Œç²˜è´´é“¾æ¥ â†’ è‡ªåŠ¨ä¸‹è½½ + å‹ç¼©ã€ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ç»™ä½ é…ä¸€ä¸ªå¯ç”¨æ–¹æ¡ˆã€‚
</p>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>
/* ========= å›¾ç‰‡æ™ºèƒ½å‹ç¼© ========= */
async function smartCompressImages() {
  const table = document.getElementById("imgTable");
  table.innerHTML =
    "<tr><th>æ–‡ä»¶</th><th>åŸå§‹</th><th>å‹ç¼©å</th><th>å‹ç¼©ç‡</th><th>ä¸‹è½½</th></tr>";

  for (const file of imgInput.files) {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    let bestBlob = null;
    for (const q of [0.82, 0.75, 0.68]) {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext("2d").drawImage(img, 0, 0);
      const blob = await new Promise(r => canvas.toBlob(r, "image/webp", q));
      if (!bestBlob || blob.size < bestBlob.size) bestBlob = blob;
    }

    const rate = ((1 - bestBlob.size / file.size) * 100).toFixed(1);

    table.innerHTML += `
      <tr>
        <td>${file.name}</td>
        <td>${(file.size/1024).toFixed(1)} KB</td>
        <td>${(bestBlob.size/1024).toFixed(1)} KB</td>
        <td>${rate}%</td>
        <td><a href="${URL.createObjectURL(bestBlob)}" download="${file.name}.webp">ä¸‹è½½</a></td>
      </tr>
    `;
  }
}

/* ========= è§†é¢‘å‹ç¼©ï¼ˆä¿®å¤ç¨³å®šç‰ˆï¼‰ ========= */
let ffmpegInstance = null;

async function getFFmpeg() {
  if (ffmpegInstance) return ffmpegInstance;
  const { createFFmpeg } = FFmpeg;
  ffmpegInstance = createFFmpeg({
    log: true,
    progress: p => videoProgress.value = p.ratio
  });
  await ffmpegInstance.load();
  return ffmpegInstance;
}

async function compressVideos() {
  if (videoInput.files.length === 0) {
    alert("è¯·é€‰æ‹©è§†é¢‘");
    return;
  }

  const ffmpeg = await getFFmpeg();
  const table = document.getElementById("videoTable");

  table.innerHTML =
    "<tr><th>æ–‡ä»¶</th><th>åŸå§‹</th><th>å‹ç¼©å</th><th>å‹ç¼©ç‡</th><th>ä¸‹è½½</th></tr>";

  let i = 0;

  for (const file of videoInput.files) {
    i++;
    const input = `in_${i}.mp4`;
    const output = `out_${i}.mp4`;

    ffmpeg.FS("writeFile", input, await FFmpeg.fetchFile(file));

    let crf;
    if (videoMode.value === "quality") crf = 24;
    else if (videoMode.value === "size") crf = 30;
    else crf = 28;

    await ffmpeg.run(
      "-i", input,
      "-vcodec", "libx264",
      "-crf", String(crf),
      "-preset", "veryfast",
      output
    );

    const data = ffmpeg.FS("readFile", output);
    const blob = new Blob([data.buffer], { type: "video/mp4" });
    const rate = ((1 - blob.size / file.size) * 100).toFixed(1);

    table.innerHTML += `
      <tr>
        <td>${file.name}</td>
        <td>${(file.size/1024/1024).toFixed(2)} MB</td>
        <td>${(blob.size/1024/1024).toFixed(2)} MB</td>
        <td>${rate}%</td>
        <td><a href="${URL.createObjectURL(blob)}" download="compressed_${file.name}">ä¸‹è½½</a></td>
      </tr>
    `;

    ffmpeg.FS("unlink", input);
    ffmpeg.FS("unlink", output);
  }

  videoProgress.value = 0;
}
</script>

</body>
</html>
