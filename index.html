<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片和视频压缩工具（客户端本地处理）</title>
    <script src="https://unpkg.com/compressorjs/dist/compressor.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        section { margin-bottom: 40px; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        input, button { margin: 10px 0; }
        #preview, #videoPreview { max-width: 100%; margin-top: 10px; }
        #result { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>图片和视频压缩工具</h1>
    <p>所有压缩都在浏览器本地完成，不上传到任何服务器，隐私安全。</p>

    <section>
        <h2>图片压缩（支持 JPEG、PNG、WebP 等）</h2>
        <input type="file" id="imageInput" accept="image/*">
        <label>压缩质量（0-1，越小文件越小，质量越低）：</label>
        <input type="range" id="imageQuality" min="0" max="1" step="0.01" value="0.8">
        <span id="qualityValue">0.8</span>
        <p><strong>推荐设置：</strong>质量 0.8（最佳质量与文件大小平衡，通常压缩 40-70%，肉眼几乎无损）</p>
        <button id="compressImage">压缩图片</button>

        <div id="imageResult"></div>
        <img id="preview" alt="原图预览">
        <img id="compressedPreview" alt="压缩后预览">
    </section>

    <section>
        <h2>视频压缩（简单重编码为 WebM/VP8 或 VP9）</h2>
        <p>使用浏览器原生 MediaRecorder 进行重编码压缩。推荐比特率 1000000（1Mbps），适合大多数短视频，文件大小大幅减小，同时质量良好。</p>
        <input type="file" id="videoInput" accept="video/*">
        <label>比特率（bits/s，越小文件越小）：</label>
        <input type="number" id="videoBitrate" value="1000000" min="100000" step="100000">
        <p><strong>推荐设置：</strong>比特率 1000000（1Mbps） - 质量最好且压缩到最小（通常可压缩 50-80%）</p>
        <button id="compressVideo">压缩视频</button>

        <div id="videoResult"></div>
        <video id="videoPreview" controls></video>
    </section>

    <script>
        // 图片部分
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const imageQuality = document.getElementById('imageQuality');
        const qualityValue = document.getElementById('qualityValue');
        const compressImageBtn = document.getElementById('compressImage');
        const imageResult = document.getElementById('imageResult');
        const compressedPreview = document.getElementById('compressedPreview');

        imageQuality.addEventListener('input', () => {
            qualityValue.textContent = imageQuality.value;
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                imageResult.innerHTML = '';
                compressedPreview.src = '';
                compressedPreview.style.display = 'none';
            }
        });

        compressImageBtn.addEventListener('click', () => {
            const file = imageInput.files[0];
            if (!file) return alert('请先选择图片');

            new Compressor(file, {
                quality: parseFloat(imageQuality.value),
                mimeType: 'image/webp',  // 推荐转为 WebP，更小且质量好
                success(result) {
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    const compressedSize = (result.size / 1024 / 1024).toFixed(2);
                    const ratio = ((1 - result.size / file.size) * 100).toFixed(1);

                    compressedPreview.src = URL.createObjectURL(result);
                    compressedPreview.style.display = 'block';

                    imageResult.innerHTML = `
                        <p>原大小: ${originalSize} MB</p>
                        <p>压缩后: \( {compressedSize} MB（压缩率 \){ratio}%）</p>
                        <a href="\( {URL.createObjectURL(result)}" download="compressed. \){result.type.split('/')[1]}">下载压缩图片</a>
                    `;
                },
                error(err) {
                    console.error(err);
                    alert('压缩失败');
                },
            });
        });

        // 视频部分
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const videoBitrate = document.getElementById('videoBitrate');
        const compressVideoBtn = document.getElementById('compressVideo');
        const videoResult = document.getElementById('videoResult');

        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                videoPreview.src = URL.createObjectURL(file);
                videoPreview.style.display = 'block';
                videoResult.innerHTML = '';
            }
        });

        compressVideoBtn.addEventListener('click', async () => {
            const file = videoInput.files[0];
            if (!file) return alert('请先选择视频');

            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playbackRate = 1; // 可加速处理，但可能影响质量

            await new Promise((resolve) => {
                video.onloadedmetadata = resolve;
            });

            await video.play();

            const stream = video.captureStream();
            const options = {
                mimeType: 'video/webm;codecs=vp9', // VP9 更好压缩，兼容性稍差；如需更好兼容用 'video/webm;codecs=vp8'
                videoBitsPerSecond: parseInt(videoBitrate.value),
            };

            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                alert('您的浏览器不支持选定的编码格式，尝试 VP8');
                options.mimeType = 'video/webm;codecs=vp8';
            }

            const mediaRecorder = new MediaRecorder(stream, options);
            const chunks = [];

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const originalSize = (file.size / 1024 / 1024).toFixed(2);
                const compressedSize = (blob.size / 1024 / 1024).toFixed(2);
                const ratio = ((1 - blob.size / file.size) * 100).toFixed(1);

                const url = URL.createObjectURL(blob);
                videoResult.innerHTML = `
                    <p>原大小: ${originalSize} MB</p>
                    <p>压缩后: \( {compressedSize} MB（压缩率 \){ratio}%）</p>
                    <video src="${url}" controls></video><br>
                    <a href="${url}" download="compressed_video.webm">下载压缩视频</a>
                `;
            };

            mediaRecorder.start();
            // 播放完自动停止
            video.onended = () => mediaRecorder.stop();
            // 为防止无限播放，设置超时
            setTimeout(() => {
                if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            }, video.duration * 1000 + 5000);
        });
    </script>
</body>
</html>
